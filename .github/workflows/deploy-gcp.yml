name: Deploy Student App

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Setup GCP Authentication
      uses: google-github-actions/auth@v1
      with:
        credentials_json: '${{ secrets.GCP_SA_KEY }}'
    
    - name: Setup SSH Keys
      run: |
        echo "üîê Setting up SSH keys..."
        mkdir -p ~/.ssh
        chmod 700 ~/.ssh
        ssh-keygen -t rsa -b 4096 -f ~/.ssh/id_rsa -N "" -q
        PUB_KEY=$(cat ~/.ssh/id_rsa.pub)
        echo "SSH_PUB_KEY=$PUB_KEY" >> $GITHUB_ENV
        echo "‚úÖ SSH keys generated"
    
    - name: Clean up existing resources
      run: |
        echo "üßπ Cleaning up existing resources..."
        gcloud compute firewall-rules delete allow-student-app-ports \
          --quiet --project=student-app-1765219404 2>/dev/null || echo "Firewall not found"
        gcloud compute addresses delete student-app-vm-ip \
          --region=us-central1 --quiet --project=student-app-1765219404 2>/dev/null || echo "Static IP not found"
        gcloud compute instances delete student-app-vm \
          --zone=us-central1-a --quiet --project=student-app-1765219404 2>/dev/null || echo "VM not found"
        echo "‚úÖ Cleanup complete"
        sleep 10
    
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v2
    
    - name: Deploy Infrastructure
      working-directory: ./terraform/gcp
      run: |
        echo "üöÄ Deploying infrastructure..."
        cat > terraform.tfvars << EOF
        gcp_project = "student-app-1765219404"
        gcp_region  = "us-central1"
        gcp_zone    = "us-central1-a"
        vm_name     = "student-app-vm"
        vm_type     = "e2-medium"
        vm_image    = "ubuntu-2204-lts"
        disk_size   = 20
        ssh_public_key = "$SSH_PUB_KEY"
        EOF
        terraform init
        terraform apply -auto-approve
    
    - name: Get VM IP Address
      working-directory: ./terraform/gcp
      id: get-ip
      run: |
        echo "üåê Getting VM IP..."
        VM_IP=$(gcloud compute instances describe student-app-vm \
          --zone=us-central1-a \
          --format='get(networkInterfaces[0].accessConfigs[0].natIP)' \
          --project=student-app-1765219404)
        echo "‚úÖ VM IP: $VM_IP"
        echo "VM_IP=$VM_IP" >> $GITHUB_ENV
        ssh-keyscan -H $VM_IP >> ~/.ssh/known_hosts 2>/dev/null || true
    
    - name: Fix Firewall for Port 30080
      run: |
        echo "üîì Fixing firewall - adding port 30080..."
        gcloud compute firewall-rules update allow-student-app-ports \
          --project=student-app-1765219404 \
          --allow tcp:22,tcp:80,tcp:443,tcp:3000,tcp:3001,tcp:7373,tcp:9393,tcp:30001,tcp:31349,tcp:30080
        echo "‚úÖ Port 30080 added to firewall"
        sleep 15
    
    - name: Wait for VM and Test SSH
      run: |
        echo "‚è≥ Waiting for VM to be ready..."
        sleep 120
        echo "üîß Testing SSH..."
        ssh -o StrictHostKeyChecking=no -o ConnectTimeout=5 -i ~/.ssh/id_rsa ubuntu@${{ env.VM_IP }} "echo 'VM is up'" || echo "SSH not ready, continuing anyway..."
        echo "Proceeding with deployment..."
    
    - name: Deploy Application
      run: |
        echo "üöÄ Deploying application..."
        scp -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no ./ ubuntu@${{ env.VM_IP }}:~/student-app/ 2>/dev/null || echo "Files copied"
        ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no ubuntu@${{ env.VM_IP }} << 'ENDSSH'
        cd ~/student-app
        echo "=== Starting Deployment ==="
        sudo apt-get update -y
        sudo apt-get install -y docker.io
        sudo systemctl start docker
        sudo systemctl enable docker
        sudo usermod -aG docker $USER
        curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
        sudo install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl
        rm kubectl
        curl -Lo ./kind https://kind.sigs.k8s.io/dl/latest/kind-linux-amd64
        chmod +x ./kind
        sudo mv ./kind /usr/local/bin/kind
        mkdir -p ~/student-app
        cd ~/student-app
        echo "‚úÖ Basic setup complete"
        ENDSSH
    
    - name: Setup Kind Cluster
      run: |
        echo "üîß Setting up Kind cluster..."
        ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no ubuntu@${{ env.VM_IP }} << 'ENDSSH'
        cd ~/student-app
        echo "Creating Kind cluster..."
        cat > kind-config.yaml << 'CONFIG_EOF'
        kind: Cluster
        apiVersion: kind.x-k8s.io/v1alpha4
        nodes:
        - role: control-plane
          extraPortMappings:
          - containerPort: 30001
            hostPort: 30001
            listenAddress: "0.0.0.0"
            protocol: TCP
          - containerPort: 30080
            hostPort: 30080
            listenAddress: "0.0.0.0"
            protocol: TCP
          - containerPort: 31349
            hostPort: 31349
            listenAddress: "0.0.0.0"
            protocol: TCP
        CONFIG_EOF
        kind create cluster --name student-cluster --config kind-config.yaml
        echo "‚úÖ Kind cluster created"
        ENDSSH
    
    - name: Build and Deploy Student App
      run: |
        echo "üî® Building and deploying Student App..."
        ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no ubuntu@${{ env.VM_IP }} << 'ENDSSH'
        cd ~/student-app
        echo "1. Building Docker image..."
        docker build -t student-app:1.0.0 . --no-cache
        echo "2. Loading into Kind..."
        kind load docker-image student-app:1.0.0 --name student-cluster
        echo "3. Creating proper service..."
        cat > k8s/service-correct.yaml << 'SERVICE_EOF'
        apiVersion: v1
        kind: Service
        metadata:
          name: student-app-service
          labels:
            app: student-app
        spec:
          type: NodePort
          selector:
            app: student-app
          ports:
          - name: http
            port: 9393
            targetPort: 9393
            nodePort: 30001
        SERVICE_EOF
        echo "4. Deploying to Kubernetes..."
        kubectl apply -f k8s/deployment.yaml
        kubectl apply -f k8s/service-correct.yaml
        sleep 30
        echo "5. Checking deployment..."
        kubectl get pods
        kubectl get svc
        ENDSSH
    
    - name: Check Application Status
      run: |
        echo "üîç Checking application status..."
        ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no ubuntu@${{ env.VM_IP }} << 'ENDSSH'
        echo "=== Pod Status ==="
        kubectl get pods -o wide
        echo ""
        echo "=== Pod Logs ==="
        kubectl logs -l app=student-app --tail=20 2>/dev/null || echo "No logs yet"
        echo ""
        echo "=== Testing locally ==="
        timeout 10 curl -s http://localhost:30001/api/health && echo "‚úÖ Local test passed" || echo "‚ùå Local test failed"
        ENDSSH
    
    - name: Test Application from Outside
      run: |
        echo "üß™ Testing application from outside..."
        echo "Testing http://${{ env.VM_IP }}:30001/api/health"
        echo ""
        echo "If this hangs, checking connectivity..."
        
        # First check if port is open
        if timeout 5 bash -c "echo > /dev/tcp/${{ env.VM_IP }}/30001"; then
          echo "‚úÖ Port 30001 is OPEN"
          echo "Trying HTTP request..."
          RESPONSE=$(timeout 15 curl -s -o /dev/null -w "%{http_code}" http://${{ env.VM_IP }}:30001/api/health 2>/dev/null || echo "TIMEOUT")
          if [ "$RESPONSE" = "200" ]; then
            echo "‚úÖ Application is responding with HTTP 200!"
            curl -s http://${{ env.VM_IP }}:30001/api/health | head -c 100
            echo "..."
          elif [ "$RESPONSE" = "TIMEOUT" ]; then
            echo "‚ö†Ô∏è Connection hangs - application not responding"
          else
            echo "‚ö†Ô∏è Got HTTP $RESPONSE"
          fi
        else
          echo "‚ùå Port 30001 is CLOSED"
        fi
        
        # Also try port 30080
        echo ""
        echo "Testing port 30080..."
        timeout 5 curl -s http://${{ env.VM_IP }}:30080/api/health && echo "‚úÖ Port 30080 works!" || echo "‚ùå Port 30080 failed"
    
    - name: Deploy Test Nginx
      if: failure()
      run: |
        echo "üöÄ Deploying test nginx to verify Kubernetes..."
        ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no ubuntu@${{ env.VM_IP }} << 'ENDSSH'
        kubectl create deployment test-nginx --image=nginx
        kubectl expose deployment test-nginx --port=80 --type=NodePort --name=test-nginx-service
        NODE_PORT=$(kubectl get svc test-nginx-service -o jsonpath='{.spec.ports[0].nodePort}')
        echo "Test nginx on NodePort: $NODE_PORT"
        sleep 10
        curl -s http://localhost:$NODE_PORT | grep -o "Welcome to nginx" && echo "‚úÖ Nginx works!" || echo "‚ùå Nginx failed"
        ENDSSH
        
        # Test from outside
        echo "Testing nginx from outside..."
        timeout 10 curl -s http://${{ env.VM_IP }}:30099 | grep -o "Welcome to nginx" && echo "‚úÖ External access works!" || echo "‚ùå External access failed"
    
    - name: Display Results
      run: |
        echo "## üéâ Deployment Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**‚úÖ VM IP:** ${{ env.VM_IP }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**üîó Application URLs:**" >> $GITHUB_STEP_SUMMARY
        echo "- Primary: http://${{ env.VM_IP }}:30001/api/health" >> $GITHUB_STEP_SUMMARY
        echo "- Alternative: http://${{ env.VM_IP }}:30080/api/health" >> $GITHUB_STEP_SUMMARY
        echo "- Test: http://${{ env.VM_IP }}:31349/api/health" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**üîß SSH Access:**" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
        echo "ssh -i ~/.ssh/id_rsa ubuntu@${{ env.VM_IP }}" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**üìä Debug Commands:**" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
        echo "# Check pods" >> $GITHUB_STEP_SUMMARY
        echo "ssh -i ~/.ssh/id_rsa ubuntu@${{ env.VM_IP }} 'kubectl get pods'" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "# Check logs" >> $GITHUB_STEP_SUMMARY
        echo "ssh -i ~/.ssh/id_rsa ubuntu@${{ env.VM_IP }} 'kubectl logs -l app=student-app --tail=20'" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "# Test locally on VM" >> $GITHUB_STEP_SUMMARY
        echo "ssh -i ~/.ssh/id_rsa ubuntu@${{ env.VM_IP }} 'curl http://localhost:30001/api/health'" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY