name: Deploy Student App

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Setup GCP Authentication
      uses: google-github-actions/auth@v1
      with:
        credentials_json: '${{ secrets.GCP_SA_KEY }}'
    
    - name: Setup SSH Keys from Secrets
      run: |
        echo "ðŸ” Setting up SSH keys from GitHub Secrets..."
        
        # Create .ssh directory
        mkdir -p ~/.ssh
        chmod 700 ~/.ssh
        
        # Save private key from secret
        echo "${{ secrets.VM_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        
        # Save public key from secret (for Terraform)
        echo "${{ secrets.VM_SSH_PUBLIC_KEY }}" > ~/.ssh/id_rsa.pub
        chmod 644 ~/.ssh/id_rsa.pub
        
        # Set public key as environment variable
        echo "SSH_PUBLIC_KEY=${{ secrets.VM_SSH_PUBLIC_KEY }}" >> $GITHUB_ENV
    
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v2
    
    - name: Deploy Infrastructure
      working-directory: ./terraform/gcp
      run: |
        echo "ðŸš€ Deploying infrastructure with Terraform..."
        
        # Create terraform.tfvars with SSH key from secret
        cat > terraform.tfvars << EOF
        gcp_project = "student-app-1765219404"
        gcp_region  = "us-central1"
        gcp_zone    = "us-central1-a"
        vm_name     = "student-app-vm"
        vm_type     = "e2-medium"
        vm_image    = "ubuntu-2204-lts"
        disk_size   = 20
        ssh_public_key = "${{ secrets.VM_SSH_PUBLIC_KEY }}"
        EOF
        
        echo "âœ… Configuration created"
        
        # Initialize and apply
        terraform init
        terraform apply -auto-approve
    
    - name: Get VM IP Address
      working-directory: ./terraform/gcp
      id: get-ip
      run: |
        echo "ðŸŒ Getting VM IP..."
        VM_IP=$(gcloud compute instances describe student-app-vm \
          --zone=us-central1-a \
          --format='get(networkInterfaces[0].accessConfigs[0].natIP)' \
          --project=student-app-1765219404)
        
        echo "âœ… VM IP: $VM_IP"
        echo "VM_IP=$VM_IP" >> $GITHUB_ENV

    - name: Configure SSH Connection
      run: |
        echo "ðŸ”§ Configuring SSH..."
        
        # Add VM to known hosts
        ssh-keyscan -H ${{ env.VM_IP }} >> ~/.ssh/known_hosts 2>/dev/null
        
        # Test SSH connection
        echo "Testing SSH to ${{ env.VM_IP }}..."
        for i in {1..10}; do
          if ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ubuntu@${{ env.VM_IP }} "echo 'SSH test successful'" 2>/dev/null; then
            echo "âœ… SSH connection established!"
            break
          fi
          echo "Attempt $i/10: SSH not ready..."
          sleep 15
        done
    
    - name: Deploy Application
      run: |
        echo "ðŸš€ Deploying application..."
        
        # Copy application files
        scp -i ~/.ssh/id_rsa -r ./ ubuntu@${{ env.VM_IP }}:/home/ubuntu/student-app/
        
        # SSH and deploy
        ssh -i ~/.ssh/id_rsa ubuntu@${{ env.VM_IP }} << 'EOF'
        set -e
        echo "=== Starting Application Deployment ==="
        
        # Navigate to app directory
        cd /home/ubuntu/student-app
        
        # Run your final-setup.sh script
        chmod +x final-setup.sh
        ./final-setup.sh
        
        echo "=== Deployment Complete ==="
        echo "Application should be available at: http://localhost:7373"
        EOF